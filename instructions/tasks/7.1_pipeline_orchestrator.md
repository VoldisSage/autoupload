# Task 7.1 – Pipeline orchestrator on stream end

## Description
Integrate all services to execute the full pipeline when a Twitch stream ends: logging, Twitch info retrieval, OpenAI metadata generation, file discovery, YouTube upload, metadata persistence, and final Discord log.

## Definition of Done
- `src/index.ts` is updated to:
  - Import and use `startStreamWatcher` from `streamWatcher`.
  - Define an async function `handleStreamOffline()` that performs the pipeline in order.
- `handleStreamOffline` MUST perform these steps in this exact sequence, logging to Discord with the specified messages:
  1. `logInfo("1. Se ha detectado el final de un directo.");`
  2. `logInfo("2. Iniciando recuperación de información de parte de twitch.");`
  3. Retrieve Twitch stream info (e.g. title, game, duration, summary, timestamps).  
     - You may implement a helper `getTwitchStreamInfo()` in `twitchService` or a new helper module.
  4. `logInfo("3. Realizando llamada a chatgpt con la información correcta");`
  5. Call `generateMetadataFromTwitch(...)` with the Twitch info.
  6. Get the last OBS recording file using `getLastRecordingFile()`.
     - If no file is found, throw an error.
  7. `logInfo("4. Obtenida información, enviando información a youtube junto al vídeo.");`
  8. Call `uploadVideoToYoutube(filePath, metadata, { dryRun: true })` initially (dryRun by default).
  9. Call `saveMarkdown(metadata, ctx)` and `appendToCsv(metadata, ctx)` with a properly built `StreamContext`.
  10. `logInfo("5. Subida completada, enlace al vídeo: " + url);`
- Any error in the pipeline:
  - Must be caught.
  - Must call `logError("Pipeline de subida fallido", error);`
  - Must NOT crash the main process entirely (only this cycle).

- `startStreamWatcher` must be wired so that:
  - On `"offline"` event, it triggers `handleStreamOffline()` after a small delay (e.g. 30 seconds).

## Tests
- Create `dev/testPipelineOffline.ts` that:
  - Calls `handleStreamOffline()` directly with mocked or simplified dependencies (or uses test config / dryRun).
  - Ensure it runs end-to-end in dryRun mode without throwing.
- Add npm script:
  - `"dev:test-pipeline-offline": "ts-node dev/testPipelineOffline.ts"` or equivalent.
- Manual integration test:
  - Run `npm run start` with dryRun enabled in config.
  - Start a real Twitch stream, then stop it.
  - Confirm via Discord that messages 1–5 appear in order.
  - Confirm a `.md` file is created in `data/videos/`.
  - Confirm `videos_metadata.csv` is updated.

## Files to create / modify
- `src/index.ts`
- Potentially `src/services/twitchService.ts` or a new helper for `getTwitchStreamInfo`.
- `dev/testPipelineOffline.ts`
- `package.json` (add dev test script)
